name: Verificacao de Qualidade (Modern Standards)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  analise-de-codigo:
    runs-on: windows-latest
    steps:
      - name: Baixar o código
        uses: actions/checkout@v4

      # GARANTIR PADRONIZAÇÃO DE ENCODING
      - name: Verificar Encoding (UTF-8 BOM Recomendado)
        shell: pwsh
        run: |
          $files = Get-ChildItem -Recurse -Include *.ps1, *.psm1
          $invalidFiles = @()
          foreach ($file in $files) {
              $bytes = Get-Content -Path $file.FullName -AsByteStream -TotalCount 3 -ErrorAction SilentlyContinue
              # Verifica assinatura EF BB BF
              if (-not ($bytes[0] -eq 0xEF -and $bytes[1] -eq 0xBB -and $bytes[2] -eq 0xBF)) {
                  Write-Host "::warning file=$($file.Name):: Arquivo sem BOM. Recomendado para compatibilidade entre editores."
                  $invalidFiles += $file.Name
              }
          }
          # Nota: Mantemos apenas aviso em vez de erro se for puramente moderno, 
          # mas para este projeto vamos manter como erro para garantir consistência.
          if ($invalidFiles.Count -gt 0) {
              Write-Error "FALHA: Converta os arquivos acima para UTF-8 com BOM no VS Code."
              exit 1
          }

      # VERIFICAÇÃO DE SINTAXE E BOAS PRÁTICAS
      - name: Executar PSScriptAnalyzer
        shell: pwsh
        run: |
          # Executamos o analisador com foco em erros críticos
          $results = Invoke-ScriptAnalyzer -Path ./ -Recurse -Severity Error
          
          if ($results) {
              $results | Format-Table -AutoSize
              Write-Error "❌ Erros de sintaxe encontrados."
              exit 1
          } else {
              Write-Host "✅ Sintaxe aprovada."
          }